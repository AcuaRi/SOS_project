<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ä½ç½®çµŒè·¯ã‚’è¦‹ã‚‹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- ì§€ë„ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

  <style>
    h1 { text-align: center; margin: 10px 0; }
    #map { height: 80vh; width: 100%; }
    #stopShareBtn {
      padding: 10px 15px;
      font-size: 16px;
      background-color: #f44336;
      color: white;
      border: none;
      cursor: pointer;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>

  <h1>í ¾í·­ æ•‘åŠ©è€…ã®ä½ç½®ã‚’è¦‹ã‚‹</h1>
  <button id="stopShareBtn">	ä½ç½®å…±æœ‰ã®åœæ­¢</button>
  <!-- ì§€ë„  -->
  <div id="map"></div>

  <!-- ì§€ë„ ìŠ¤í¬ë¦½íŠ¸ -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

  <script>
    const jwt = localStorage.getItem("jwt_token");
    const urlParams = new URLSearchParams(window.location.search);
    const fromId = urlParams.get("from");
    let myLatLng = null, fromLatLng = null;

    const map = L.map("map").setView([37.5665, 126.9780], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    let myMarker, fromMarker, routingControl;

    // ë‚´ ìœ„ì¹˜ ê°±ì‹  & ì„œë²„ì— ì €ì¥
    navigator.geolocation.getCurrentPosition(async (pos) => {
      myLatLng = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      
      // ë‚´ ìœ„ì¹˜ ì„œë²„ì— ì €ì¥
      await fetch("/navigation/location", {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + jwt,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(myLatLng)
      });
      if (!myMarker) {
        myMarker = L.marker([myLatLng.lat, myLatLng.lng]).addTo(map).bindPopup("è‡ªåˆ†ã®ä½ç½®").openPopup();
      } else {
        myMarker.setLatLng([myLatLng.lat, myLatLng.lng]);
      }
      tryDrawRoute();
    });

    // êµ¬ì¡°ìš”ì²­ì(fromId)ì˜ ìœ„ì¹˜ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadFromLocation() {
      if (!fromId) return;
      const res = await fetch(`/navigation/location/${fromId}`);
      if (!res.ok) {
        alert("ç›¸æ‰‹ã®ä½ç½®å…±æœ‰ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚")
        window.location.href = "/static/button.html";
        return
      }
      fromLatLng = await res.json();
      if (fromLatLng && fromLatLng.lat && fromLatLng.lng) {
        if (!fromMarker) {
          fromMarker = L.marker([fromLatLng.lat, fromLatLng.lng]).addTo(map).bindPopup("êµ¬ì¡° ìš”ì²­ì ìœ„ì¹˜");
        } else {
          fromMarker.setLatLng([fromLatLng.lat, fromLatLng.lng]);
        }
        tryDrawRoute();
      }
    }
    loadFromLocation();

    // êµ¬ì¡°ìš”ì²­ìì™€ ë‚´ìœ„ì¹˜ ê²½ë¡œ ê·¸ë¦¬ê¸°
    function tryDrawRoute() {
      if (myLatLng && fromLatLng) {
        if (routingControl) map.removeControl(routingControl);
        routingControl = L.Routing.control({
          waypoints: [
            L.latLng(myLatLng.lat, myLatLng.lng),
            L.latLng(fromLatLng.lat, fromLatLng.lng)
          ]
        }).addTo(map);
      }
    }
    loadFromLocation();

  document.getElementById('stopShareBtn').onclick = async function() {
    if (!confirm("æœ¬å½“ã«ä½ç½®å…±æœ‰ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ")) return;
    const jwt = localStorage.getItem("jwt_token");
    const res = await fetch("/navigation/location", {
      method: "DELETE",
      headers: { "Authorization": "Bearer " + jwt }
    });
    const data = await res.json();
    if (data.success) {
      alert("ä½ç½®å…±æœ‰ãŒåœæ­¢ã•ã‚Œã¾ã—ãŸã€‚");
      window.location.href = "/static/button.html";
    } else {
      alert("ä½ç½®ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸï¼š " + (data.msg || ""));
    }
  };
  </script>
</body>
</html>
