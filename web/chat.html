<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Symptom guide for emergencies</title>
  <link rel="stylesheet" href="/web/chat.css">
</head>
<body>
  <div class="chat-container">
    <div class="top-bar">
      <span class="back-arrow">â†</span>
      <span class="bookmark">ğŸ”–</span>
    </div>

    <!-- ì±„íŒ… ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ -->
    <div id="chat-log">
      <div class="chat-bubble bot">
        <img src="https://via.placeholder.com/40" class="icon" alt="Bot">
        <div class="message">ã“ã‚“ã«ã¡ã¯ã€OOã•ã‚“ã€‚ç—‡çŠ¶ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã‚Œã°ã€è§£æ±ºç­–ã‚’ãŠæ¢ã—ã—ã¾ã™ï¼</div>
      </div>
    </div>

    <!-- ì…ë ¥ ì˜ì—­ -->
    <form id="chat-form" enctype="multipart/form-data">
      <div class="input-area">
        <!-- ì´ë¯¸ì§€ ë²„íŠ¼ -->
        <label for="image-upload" class="icon-button">â•</label>
        <input type="file" id="image-upload" name="image" accept="image/*" hidden>

        <!-- ìŒì„± ë²„íŠ¼ -->
        <button type="button" id="record-toggle">ğŸ™ï¸</button>
        <input type="file" id="audio-upload" name="audio" accept="audio/*" hidden>

        <input type="hidden" id="latitude" name="latitude">
        <input type="hidden" id="longitude" name="longitude">

        <!-- í…ìŠ¤íŠ¸ ì…ë ¥ -->
        <span class="divider"></span> 
        <input type="text" name="symptom" id="symptom-input" placeholder="ì¦ìƒì„ ì…ë ¥í•´ì£¼ì„¸ìš”">

        <button type="submit">ë³´ë‚´ê¸°</button>
      </div>
    </form>

    <!-- í•˜ë‹¨ ë©”ë‰´ -->
    <div class="bottom-nav">
      <div class="nav-item selected">
        <span>â˜°</span><br>guide
      </div>
      <div class="nav-item">
        <span>ğŸ”–</span><br>ì •ë³´ ì €ì¥
      </div>
      <div class="nav-item">
        <span>ğŸ‘¤</span><br>ê³„ì •
      </div>
    </div>
  </div>

  <!-- ìœ„ì¹˜ ì •ë³´ ì„¤ì • -->
  <script>
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        document.getElementById("latitude").value = lat;
        document.getElementById("longitude").value = lng;
        // ì„œë²„ë¡œ ìœ„ì¹˜ ì „ì†¡
        fetch("http://localhost:8000/location", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            latitude: lat,
            longitude: lng
          })
        })
        .then(res => res.json())
        .then(data => console.log("ì„œë²„ ì‘ë‹µ:", data))
        .catch(err => console.error("ì „ì†¡ ì˜¤ë¥˜:", err));
      },
      (err) => {
        console.error("ìœ„ì¹˜ ì¶”ì  ì‹¤íŒ¨:", err);
      }
    );
  </script>

<script>
  let currentLatitude = null;
  let currentLongitude = null;

  // ìœ„ì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸° 
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        document.getElementById("latitude").value = lat;
        document.getElementById("longitude").value = lng;
        // ì„œë²„ë¡œ ìœ„ì¹˜ ì „ì†¡
        fetch("http://localhost:8000/location", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            latitude: lat,
            longitude: lng
          })
        })
        .then(res => res.json())
        .then(data => console.log("ì„œë²„ ì‘ë‹µ:", data))
        .catch(err => console.error("ì „ì†¡ ì˜¤ë¥˜:", err));
      },
      (err) => {
        console.error("ìœ„ì¹˜ ì¶”ì  ì‹¤íŒ¨:", err);
      }
    );

  document.getElementById("chat-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const form = e.target;
    const formData = new FormData(form);
    const chatLog = document.getElementById("chat-log");

    const symptomInput = document.getElementById("symptom-input");
    const symptomText = symptomInput.value.trim();
    const audio = formData.get("audio");

    // ì‚¬ìš©ì ë§í’ì„  ì¶œë ¥ í•¨ìˆ˜
    function appendUserBubble(message) {
      chatLog.insertAdjacentHTML("beforeend", `
        <div class="chat-bubble user">
          <div class="message">${message}</div>
          <img src="https://via.placeholder.com/40" class="icon" alt="User">
        </div>
      `);
    }

    // ë¶„ì„ ì¤‘ í‘œì‹œ
    function showLoadingBubble() {
      const loadingMessage = document.createElement("div");
      loadingMessage.className = "chat-bubble bot";
      loadingMessage.id = "loading-bubble";
      loadingMessage.innerHTML = `
        <img src="https://via.placeholder.com/40" class="icon" alt="Bot">
        <div class="message loading">ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤</div>
      `;
      chatLog.appendChild(loadingMessage);
    }

    // ë¶„ì„ ì¤‘ ì œê±°
    function removeLoadingBubble() {
      document.getElementById("loading-bubble")?.remove();
    }

    // ë´‡ ì‘ë‹µ ì¶œë ¥
    function showBotReply(replyText) {
      chatLog.insertAdjacentHTML("beforeend", `
        <div class="chat-bubble bot">
          <img src="https://via.placeholder.com/40" class="icon" alt="Bot">
          <div class="message">${replyText.replace(/\n/g, "<br>")}</div>
        </div>
      `);
    }

    //  ë¶„ì„ ìš”ì²­ í•¨ìˆ˜
    async function sendToAnalyze(finalSymptom) {
      const analyzeForm = new FormData(form);  // ëª¨ë“  input í¬í•¨
      analyzeForm.set("symptom", finalSymptom); // symptomë§Œ ë®ì–´ì“°ê¸°

      // ë””ë²„ê¹…ìš© ì¶œë ¥
      // for (const [key, value] of analyzeForm.entries()) console.log(key, value);

      const res = await fetch("/analyze", {
        method: "POST",
        body: analyzeForm
      });

      const result = await res.json();
      removeLoadingBubble();
      showBotReply(result.reply);
    }

    // í…ìŠ¤íŠ¸ ì…ë ¥ ì²˜ë¦¬
    if (symptomText.length > 0) {
      appendUserBubble(symptomText);
      showLoadingBubble();
      await sendToAnalyze(symptomText);
      symptomInput.value = "";
    }

    // ìŒì„± ì…ë ¥ ì²˜ë¦¬
    else if (audio && audio.size > 0) {
      const sttForm = new FormData();
      sttForm.append("audio", audio);

      const sttRes = await fetch("/stt", {
        method: "POST",
        body: sttForm
      });

      const sttResult = await sttRes.json();
      const sttText = sttResult.stt_text?.trim();

      if (!sttText) return;

      appendUserBubble(sttText);
      showLoadingBubble();
      await sendToAnalyze(sttText);
    }
  });
</script>

<!-- ìŒì„± ë…¹ìŒ ì²˜ë¦¬ -->
<script>
  let mediaRecorder;
  let audioChunks = [];
  let isRecording = false;

  document.getElementById("record-toggle").addEventListener("click", async () => {
    const button = document.getElementById("record-toggle");

    if (!isRecording) {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = event => {
        audioChunks.push(event.data);
      };

      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
        const file = new File([audioBlob], "recorded_audio.webm", { type: "audio/webm" });
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);

        document.getElementById("audio-upload").files = dataTransfer.files;

        // í…ìŠ¤íŠ¸ ì…ë ¥ ì´ˆê¸°í™” í›„ ìë™ ì œì¶œ
        document.getElementById("symptom-input").value = "";
        document.getElementById("chat-form").dispatchEvent(new Event("submit", { cancelable: true }));
      };

      mediaRecorder.start();
      isRecording = true;
      button.textContent = "ğŸ”´";
    } else {
      mediaRecorder.stop();
      isRecording = false;
      button.textContent = "ğŸŸ¥";
    }
  });
</script>


  
</body>
</html>
