<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç®¡ç†è€…ãƒãƒƒãƒ—ãƒ“ãƒ¥ãƒ¼ã‚¢</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <style>
    #map { height: 80vh; width: 100%; }
    #controls { margin: 10px; }
    select, button { margin-right: 10px; padding: 10px 15px; font-size: 16px; }
    h3 { margin: 10px; }
    #alert {
      display: none;
      font-size: 20px;
      color: red;
      font-weight: bold;
      margin: 10px;
    }
    @keyframes flash {
      0%, 100% { background-color: transparent; }
      50% { background-color: rgba(255, 0, 0, 0.3); }
    }
    #map.flash-alert {
      animation: flash 1s infinite;
    }
    .emergency-marker {
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <h3>ğŸ—ºï¸ ç®¡ç†è€…ãƒãƒƒãƒ—ãƒ“ãƒ¥ãƒ¼ã‚¢</h3>
  <div id="controls">
    <label for="layerSelect">ãƒ¬ã‚¤ãƒ¤ãƒ¼: </label>
    <select id="layerSelect">
      <option value="1" selected>ãƒ¬ã‚¤ãƒ¤ãƒ¼ 1 (é’)</option>
      <option value="2">ãƒ¬ã‚¤ãƒ¤ãƒ¼ 2 (èµ¤)</option>
      <option value="3">ãƒ¬ã‚¤ãƒ¤ãƒ¼ 3 (ç·‘)</option>
      <option value="4">ãƒ¬ã‚¤ãƒ¤ãƒ¼ 4 (ã‚ªãƒ¬ãƒ³ã‚¸)</option>
      <option value="5">ãƒ¬ã‚¤ãƒ¤ãƒ¼ 5 (ç´«)</option>
      <option value="999">ãƒ¬ã‚¤ãƒ¤ãƒ¼ 999 (èµ¤ - ç·Šæ€¥)</option>
    </select>
    <button onclick="loadHospitalData()">ë³‘ì› ë°ì´í„° ë¡œë“œ</button>
  </div>
  <div id="alert">â— ç·Šæ€¥æ•‘åŠ©è¦è«‹ç™ºç”Ÿ â—</div>
  <div id="map"></div>
  <audio id="alertSound" src="https://www.soundjay.com/buttons/sounds/beep-07.mp3" preload="auto"></audio>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    const LAYER_COLORS = {
      1: 'blue', 2: 'red', 3: 'green', 4: 'orange', 5: 'purple',
      999: 'red'
    };
    const MAP_CENTER = [35.6762, 139.6503];
    let lastTimestamp = null;
    const layerGroups = {};
    const overlays = {};
    let allMarkers = {}; // ëª¨ë“  ë ˆì´ì–´ ë°ì´í„°ë¥¼ ì €ì¥

    const map = L.map('map').setView(MAP_CENTER, 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data Â© OpenStreetMap contributors'
    }).addTo(map);

    // í´ëŸ¬ìŠ¤í„° ê·¸ë£¹ ì´ˆê¸°í™”
    Object.keys(LAYER_COLORS).forEach(layer => {
      if (layer === '999') {
        layerGroups[layer] = L.layerGroup().addTo(map);
      } else {
        layerGroups[layer] = L.markerClusterGroup({
          maxClusterRadius: 50,
          disableClusteringAtZoom: 15
        }).addTo(map);
      }
      overlays[`ãƒ¬ã‚¤ãƒ¤ãƒ¼ ${layer} (${LAYER_COLORS[layer]} ãƒãƒ¼ã‚«ãƒ¼)`] = layerGroups[layer];
      allMarkers[layer] = []; // ê° ë ˆì´ì–´ì— ëŒ€í•œ ë§ˆì»¤ ë°°ì—´ ì´ˆê¸°í™”
    });

    L.control.layers(null, overlays).addTo(map);

    // ë§ˆì»¤ ìƒì„± í•¨ìˆ˜
    function createMarker(m, layer) {
      if (m.lat == null || m.lon == null || isNaN(m.lat) || isNaN(m.lon) ||
          m.lat < -90 || m.lat > 90 || m.lon < -180 || m.lon > 180) {
        console.warn(`Invalid coordinates for marker ID ${m.id}: lat=${m.lat}, lon=${m.lon}`);
        return null;
      }
      const isUser = Number(layer) === 999;
      const marker = L.marker([m.lat, m.lon], {
        icon: L.icon({
          iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${LAYER_COLORS[layer]}.png`,
          iconSize: isUser ? [35, 51] : [25, 41],
          iconAnchor: isUser ? [17.5, 51] : [12.5, 41],
          popupAnchor: [0, -51],
          shadowUrl: isUser ? 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png' : null,
          shadowSize: isUser ? [41, 41] : null
        })
      })
        .bindPopup(isUser ?
          `<b>ğŸ“ ç·Šæ€¥è¦è«‹ä½ç½®</b><br/>
           ID: ${m.id}<br/>
           åå‰: ${m.name || 'N/A'}<br/>
           é›»è©±: ${m.phone || 'N/A'}<br/>
           <button onclick="confirmMarker(${m.id})">âœ… ç¢ºèª</button>` :
          `<b>ğŸ¥ ç—…é™¢</b><br/>
           ID: ${m.id}<br/>
           åå‰: ${m.name || 'N/A'}<br/>
           é›»è©±: ${m.phone || 'N/A'}`
        )
        .on('add', () => {
          console.log(`Marker ID ${m.id} added to layer ${layer} at [${m.lat}, ${m.lon}]`);
        });
      return marker;
    }

    // ë ˆì´ì–´ ë°ì´í„° í‘œì‹œ
    function displayLayerData(layer) {
      layerGroups[layer].clearLayers();
      const bounds = map.getBounds().pad(0.5);
      const markers = allMarkers[layer].filter(m =>
        m.lat >= bounds.getSouth() && m.lat <= bounds.getNorth() &&
        m.lon >= bounds.getWest() && m.lon <= bounds.getEast()
      );
      markers.forEach(m => {
        const marker = createMarker(m, layer);
        if (marker) layerGroups[layer].addLayer(marker);
      });
      console.log(`Displayed ${markers.length} markers for layer ${layer}`);
    }

    // ëª¨ë“  ë ˆì´ì–´ ë°ì´í„° ë¡œë“œ
    async function loadAllData() {
      try {
        for (const layer of Object.keys(LAYER_COLORS)) {
          const response = await fetch(`/hospital/data/${layer}`);
          if (!response.ok) {
            console.warn(`Failed to fetch data for layer ${layer}: ${response.status} ${response.statusText}`);
            continue;
          }
          const data = await response.json();
          allMarkers[layer] = data[`markers_${layer}`] || [];
          console.log(`Loaded ${allMarkers[layer].length} markers for layer ${layer}`);
        }
        displayLayerData(document.getElementById('layerSelect').value);
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ë³‘ì› ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
    async function loadHospitalData() {
      try {
        const res = await fetch('/hospital/load-hospitals_jp', {
          method: 'POST'
        });
        if (res.ok) {
          const result = await res.json();
          alert(`${result.message}`);
          await loadAllData(); // ë°ì´í„° ë¡œë“œ í›„ ëª¨ë“  ë ˆì´ì–´ ê°±ì‹ 
        } else {
          const error = await res.json();
          alert(`èª­ã¿è¾¼ã¿å¤±æ•—: ${error.detail || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'}`);
        }
      } catch (err) {
        alert("ë¦¬í€˜ìŠ¤íŠ¸ ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤");
        console.error(err);
      }
    }

    // WebSocket ì„¤ì •
    //let ws = new WebSocket('ws://localhost:8000/hospital/ws');
    let ws = new WebSocket(`ws://${location.host}/hospital/ws`);
    ws.onopen = () => {
      console.log('WebSocket ì—°ê²° ì„±ê³µ');
    };
    ws.onmessage = async (event) => {
      try {
        const data = JSON.parse(event.data);
        if (data.timestamp !== lastTimestamp) {
          lastTimestamp = data.timestamp;
          const layer = data.layer;
          const action = data.action;
          console.log(`WebSocket message received: layer=${layer}, action=${action}`);
          // íŠ¹ì • ë ˆì´ì–´ ë°ì´í„°ë§Œ ê°±ì‹ 
          const response = await fetch(`/hospital/data/${layer}`);
          if (response.ok) {
            const updatedData = await response.json();
            allMarkers[layer] = updatedData[`markers_${layer}`] || [];
            if (document.getElementById('layerSelect').value === String(layer)) {
              displayLayerData(layer);
            }
            if (Number(layer) === 999 && action === 'add') {
              triggerEmergencyAlert();
              document.getElementById('layerSelect').value = '999';
              displayLayerData(999);
            }
          }
        }
      } catch (error) {
        console.error('WebSocket ë©”ì‹œì§€ ì²˜ë¦¬ ì—ëŸ¬:', error);
      }
    };
    ws.onclose = () => {
      console.log('WebSocket ì—°ê²° ì¢…ë£Œ, 3ì´ˆ í›„ ì¬ì—°ê²° ì‹œë„');
      setTimeout(() => {
        //ws = new WebSocket('ws://localhost:8000/hospital/ws');
      	ws = new WebSocket(`ws://${location.host}/hospital/ws`);
      }, 3000);
    };
    ws.onerror = (error) => {
      console.error('WebSocket ì—ëŸ¬:', error);
    };

    // ê¸´ê¸‰ ì•Œë¦¼ í•¨ìˆ˜
    function triggerEmergencyAlert() {
      const alertBox = document.getElementById('alert');
      const sound = document.getElementById('alertSound');
      const mapDiv = document.getElementById('map');
      alertBox.style.display = 'block';
      sound.play();
      mapDiv.classList.add('flash-alert');
      setTimeout(() => {
        alertBox.style.display = 'none';
        mapDiv.classList.remove('flash-alert');
      }, 10000);
    }

    // ë§ˆì»¤ í™•ì¸
    async function confirmMarker(id) {
      try {
        const res = await fetch(`/hospital/confirm-marker/${id}`, {
          method: 'DELETE'
        });
        if (res.ok) {
          alert(`ãƒãƒ¼ã‚«ãƒ¼ ID ${id} ãŒç¢ºèªã•ã‚Œã€å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚`);
          allMarkers[999] = allMarkers[999].filter(m => m.id !== id);
          displayLayerData(999);
        } else {
          const error = await res.json();
          alert(`å‰Šé™¤å¤±æ•—: ${error.detail}`);
        }
      } catch (err) {
        alert("ë¦¬í€˜ìŠ¤íŠ¸ ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤");
        console.error(err);
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë“  ë°ì´í„° ë¡œë“œ
    loadAllData();

    // ë ˆì´ì–´ ì„ íƒ ì‹œ ë°ì´í„° í‘œì‹œ
    document.getElementById('layerSelect').addEventListener('change', () => {
      displayLayerData(document.getElementById('layerSelect').value);
    });

    // ì§€ë„ ì´ë™/ì¤Œ ì‹œ ë°ì´í„° ê°±ì‹ 
    map.on('moveend zoomend', () => {
      displayLayerData(document.getElementById('layerSelect').value);
    });
  </script>
</body>
</html>
