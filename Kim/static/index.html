<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Map Viewer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    #map { height: 80vh; width: 100%; }
    #controls { margin: 10px; }
    select { margin-right: 10px; padding: 10px 15px; font-size: 16px; }
    h3 { margin: 10px; }

    /* ê¸´ê¸‰ ì•Œë¦¼ í…ìŠ¤íŠ¸ */
    #alert {
      display: none;
      font-size: 20px;
      color: red;
      font-weight: bold;
      margin: 10px;
    }

    /* ê¹œë¹¡ì„ íš¨ê³¼ */
    @keyframes flash {
      0%, 100% { background-color: transparent; }
      50% { background-color: rgba(255, 0, 0, 0.3); }
    }
    #map.flash-alert {
      animation: flash 1s infinite;
    }
  </style>
</head>
<body>
  <h3>ğŸ—ºï¸ Admin Map Viewer</h3>
  <div id="controls">
    <label for="layerSelect">Layer: </label>
    <select id="layerSelect">
      <option value="1" selected>Layer 1 (blue)</option>
      <option value="2">Layer 2 (red)</option>
      <option value="3">Layer 3 (green)</option>
      <option value="4">Layer 4 (orange)</option>
      <option value="5">Layer 5 (purple)</option>
      <option value="6">Layer 6 (brown)</option>
      <option value="7">Layer 7 (pink)</option>
      <option value="8">Layer 8 (gray)</option>
      <option value="9">Layer 9 (black)</option>
      <option value="10">Layer 10 (cyan)</option>
      <option value="29">Layer 29 (yellow)</option>
      <option value="31">Layer 31 (darkgreen)</option>
      <option value="999">Layer 999 (red - emergency)</option>
    </select>
  </div>

  <div id="alert">â— ì‘ê¸‰ êµ¬ì¡° ìš”ì²­ ë°œìƒ â—</div>
  <div id="map"></div>

  <!-- ê²½ê³  ì‚¬ìš´ë“œ -->
  <audio id="alertSound" src="https://www.soundjay.com/buttons/sounds/beep-07.mp3" preload="auto"></audio>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const LAYER_COLORS = {
      1: 'blue', 2: 'red', 3: 'green', 4: 'orange', 5: 'purple',
      6: 'brown', 7: 'pink', 8: 'gray', 9: 'black', 10: 'cyan',
      29: 'yellow', 31: 'darkgreen',
      999: 'red'  // ğŸ”´ ì‘ê¸‰ êµ¬ì¡° ìš”ì²­ ë§ˆì»¤
    };

    const MAP_CENTER = [37.5665, 126.9780];
    let lastTimestamp = null;
    const layerGroups = {};
    const overlays = {};

    const map = L.map('map').setView(MAP_CENTER, 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data Â© OpenStreetMap contributors'
    }).addTo(map);

    // ë ˆì´ì–´ ê·¸ë£¹ ì´ˆê¸°í™”
    Object.keys(LAYER_COLORS).forEach(layer => {
      layerGroups[layer] = {
        markers: L.layerGroup().addTo(map),
        paths: L.layerGroup().addTo(map)
      };
      overlays[`Layer ${layer} (${LAYER_COLORS[layer]} markers)`] = layerGroups[layer].markers;
      overlays[`Layer ${layer} (${LAYER_COLORS[layer]} paths)`] = layerGroups[layer].paths;
    });

    L.control.layers(null, overlays).addTo(map);

    // ë ˆì´ì–´ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadLayerData(layer) {
      try {
        const response = await fetch(`/data/${layer}`);
        if (!response.ok) return;
        const data = await response.json();

        layerGroups[layer].markers.clearLayers();
        layerGroups[layer].paths.clearLayers();

        if (data[`markers_${layer}`]) {
          data[`markers_${layer}`].forEach(m => {
            const isUser = Number(layer) === 999;
            L.marker([m.lat, m.lon], {
              icon: L.icon({
                iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${LAYER_COLORS[layer]}.png`,
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34]
              })
            })
              .bindPopup(`
                <b>ğŸ“ ì‘ê¸‰ ìš”ì²­ ìœ„ì¹˜</b><br/>
                ID: ${m.id}<br/>
                <button onclick="confirmMarker(${m.id})">âœ… í™•ì¸</button>`)
              .addTo(layerGroups[layer].markers);
          });
        }

        if (data[`paths_${layer}`]?.length > 0) {
          L.polyline(data[`paths_${layer}`].map(p => [p.lat, p.lon]), {
            color: LAYER_COLORS[layer]
          }).addTo(layerGroups[layer].paths);
        }
      } catch (error) {
        console.error(`Error loading layer ${layer}:`, error);
      }
    }

    // reload ê°ì§€
    async function checkReload() {
      try {
        const response = await fetch('/reload.txt');
        const data = await response.json();
        if (data.timestamp !== lastTimestamp) {
          lastTimestamp = data.timestamp;
          loadLayerData(data.layer);

          if (Number(data.layer) === 999) {
            triggerEmergencyAlert();
          }
        }
      } catch (error) {
        console.error('Error checking reload:', error);
      }
    }

    // ê¸´ê¸‰ ì•Œë¦¼ í•¨ìˆ˜
    function triggerEmergencyAlert() {
      const alertBox = document.getElementById('alert');
      const sound = document.getElementById('alertSound');
      const mapDiv = document.getElementById('map');

      alertBox.style.display = 'block';
      sound.play();
      mapDiv.classList.add('flash-alert');

      setTimeout(() => {
        alertBox.style.display = 'none';
        mapDiv.classList.remove('flash-alert');
      }, 10000); // 10ì´ˆ í›„ ìë™ ì¢…ë£Œ
    }

    async function confirmMarker(id) {
  try {
    const res = await fetch(`/confirm-marker/${id}`, {
      method: 'DELETE'
    });
    if (res.ok) {
      alert(`ë§ˆì»¤ ID ${id}ê°€ í™•ì¸ë˜ì–´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      loadLayerData(999); // ì¦‰ì‹œ ìƒˆë¡œê³ ì¹¨
    } else {
      const error = await res.json();
      alert(`ì‚­ì œ ì‹¤íŒ¨: ${error.detail}`);
    }
  } catch (err) {
    alert("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
    console.error(err);
  }
}

    // ì²˜ìŒ ëª¨ë“  ë ˆì´ì–´ ë¶ˆëŸ¬ì˜¤ê¸°
    Object.keys(LAYER_COLORS).forEach(loadLayerData);

    // ì£¼ê¸°ì ìœ¼ë¡œ ë³€ê²½ ê°ì§€
    setInterval(checkReload, 5000);
  </script>
</body>
</html>
