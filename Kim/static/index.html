<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç®¡ç†è€…ãƒãƒƒãƒ—ãƒ“ãƒ¥ãƒ¼ã‚¢</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <style>
    #map { height: 80vh; width: 100%; }
    #controls { margin: 10px; }
    select { margin-right: 10px; padding: 10px 15px; font-size: 16px; }
    h3 { margin: 10px; }
    #alert {
      display: none;
      font-size: 20px;
      color: red;
      font-weight: bold;
      margin: 10px;
    }
    @keyframes flash {
      0%, 100% { background-color: transparent; }
      50% { background-color: rgba(255, 0, 0, 0.3); }
    }
    #map.flash-alert {
      animation: flash 1s infinite;
    }
  </style>
</head>
<body>
  <h3>ğŸ—ºï¸ ç®¡ç†è€…ãƒãƒƒãƒ—ãƒ“ãƒ¥ãƒ¼ã‚¢</h3>
  <div id="controls">
    <label for="layerSelect">ãƒ¬ã‚¤ãƒ¤ãƒ¼: </label>
    <select id="layerSelect">
      <option value="1" selected>ãƒ¬ã‚¤ãƒ¤ãƒ¼ 1 (é’)</option>
      <option value="2">ãƒ¬ã‚¤ãƒ¤ãƒ¼ 2 (èµ¤)</option>
      <option value="3">ãƒ¬ã‚¤ãƒ¤ãƒ¼ 3 (ç·‘)</option>
      <option value="4">ãƒ¬ã‚¤ãƒ¤ãƒ¼ 4 (ã‚ªãƒ¬ãƒ³ã‚¸)</option>
      <option value="5">ãƒ¬ã‚¤ãƒ¤ãƒ¼ 5 (ç´«)</option>
      <option value="6">ãƒ¬ã‚¤ãƒ¤ãƒ¼ 6 (èŒ¶)</option>
      <option value="7">ãƒ¬ã‚¤ãƒ¤ãƒ¼ 7 (ãƒ”ãƒ³ã‚¯)</option>
      <option value="8">ãƒ¬ã‚¤ãƒ¤ãƒ¼ 8 (ç°è‰²)</option>
      <option value="9">ãƒ¬ã‚¤ãƒ¤ãƒ¼ 9 (é»’)</option>
      <option value="10">ãƒ¬ã‚¤ãƒ¤ãƒ¼ 10 (ã‚·ã‚¢ãƒ³)</option>
      <option value="29">ãƒ¬ã‚¤ãƒ¤ãƒ¼ 29 (é»„è‰²)</option>
      <option value="31">ãƒ¬ã‚¤ãƒ¤ãƒ¼ 31 (æ¿ƒç·‘)</option>
      <option value="999">ãƒ¬ã‚¤ãƒ¤ãƒ¼ 999 (èµ¤ - ç·Šæ€¥)</option>
    </select>
  </div>
  <div id="alert">â— ç·Šæ€¥æ•‘åŠ©è¦è«‹ç™ºç”Ÿ â—</div>
  <div id="map"></div>
  <audio id="alertSound" src="https://www.soundjay.com/buttons/sounds/beep-07.mp3" preload="auto"></audio>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    const LAYER_COLORS = {
      1: 'blue', 2: 'red', 3: 'green', 4: 'orange', 5: 'purple',
      6: 'brown', 7: 'pink', 8: 'gray', 9: 'black', 10: 'cyan',
      29: 'yellow', 31: 'darkgreen',
      999: 'red'
    };
    const MAP_CENTER = [35.6762, 139.6503];
    let lastTimestamp = null;
    const layerGroups = {};
    const overlays = {};

    const map = L.map('map').setView(MAP_CENTER, 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data Â© OpenStreetMap contributors'
    }).addTo(map);

    // ã‚¯ãƒ©ã‚¹ã‚¿ã‚°ãƒ«ãƒ¼ãƒ—åˆæœŸåŒ–
    Object.keys(LAYER_COLORS).forEach(layer => {
      layerGroups[layer] = L.markerClusterGroup({
        maxClusterRadius: 50,
        disableClusteringAtZoom: 15
      }).addTo(map);
      overlays[`ãƒ¬ã‚¤ãƒ¤ãƒ¼ ${layer} (${LAYER_COLORS[layer]} ãƒãƒ¼ã‚«ãƒ¼)`] = layerGroups[layer];
    });

    L.control.layers(null, overlays).addTo(map);

    // ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆãƒ™ãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
    async function loadLayerData(layer) {
      const bounds = map.getBounds();
      const params = new URLSearchParams({
        min_lat: bounds.getSouth(),
        max_lat: bounds.getNorth(),
        min_lon: bounds.getWest(),
        max_lon: bounds.getEast()
      });
      console.log(`Loading layer ${layer} with bounds:`, {
        min_lat: bounds.getSouth(),
        max_lat: bounds.getNorth(),
        min_lon: bounds.getWest(),
        max_lon: bounds.getEast()
      });
      try {
        const response = await fetch(`/data/${layer}?${params}`);
        if (!response.ok) {
          console.warn(`Failed to fetch data for layer ${layer}: ${response.status}`);
          return;
        }
        const data = await response.json();
        console.log(`Received ${data[`markers_${layer}`]?.length || 0} markers for layer ${layer}`);

        layerGroups[layer].clearLayers();

        if (data[`markers_${layer}`]) {
          data[`markers_${layer}`].forEach(m => {
            const isUser = Number(layer) === 999;
            L.marker([m.lat, m.lon], {
              icon: L.icon({
                iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${LAYER_COLORS[layer]}.png`,
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34]
              })
            })
              .bindPopup(isUser ?
                `<b>ğŸ“ ç·Šæ€¥è¦è«‹ä½ç½®</b><br/>
                 ID: ${m.id}<br/>
                 åå‰: ${m.name || 'N/A'}<br/>
                 é›»è©±: ${m.phone || 'N/A'}<br/>
                 <button onclick="confirmMarker(${m.id})">âœ… ç¢ºèª</button>` :
                `<b>ğŸ¥ ç—…é™¢</b><br/>
                 ID: ${m.id}<br/>
                 åå‰: ${m.name || 'N/A'}<br/>
                 é›»è©±: ${m.phone || 'N/A'}`
              )
              .addTo(layerGroups[layer]);
          });
        }
      } catch (error) {
        console.error(`ãƒ¬ã‚¤ãƒ¤ãƒ¼ ${layer} ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:`, error);
      }
    }

    // ãƒªãƒ­ãƒ¼ãƒ‰æ¤œçŸ¥
    async function checkReload() {
      try {
        const response = await fetch('/reload.txt');
        const data = await response.json();
        if (data.timestamp !== lastTimestamp) {
          lastTimestamp = data.timestamp;
          loadLayerData(data.layer);
          if (Number(data.layer) === 999) {
            triggerEmergencyAlert();
          }
        }
      } catch (error) {
        console.error('ãƒªãƒ­ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ç·Šæ€¥ã‚¢ãƒ©ãƒ¼ãƒˆé–¢æ•°
    function triggerEmergencyAlert() {
      const alertBox = document.getElementById('alert');
      const sound = document.getElementById('alertSound');
      const mapDiv = document.getElementById('map');

      alertBox.style.display = 'block';
      sound.play();
      mapDiv.classList.add('flash-alert');

      setTimeout(() => {
        alertBox.style.display = 'none';
        mapDiv.classList.remove('flash-alert');
      }, 10000);
    }

    // ãƒãƒ¼ã‚«ãƒ¼ç¢ºèª
    async function confirmMarker(id) {
      try {
        const res = await fetch(`/confirm-marker/${id}`, {
          method: 'DELETE'
        });
        if (res.ok) {
          alert(`ãƒãƒ¼ã‚«ãƒ¼ ID ${id} ãŒç¢ºèªã•ã‚Œã€å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚`);
          loadLayerData(999);
        } else {
          const error = await res.json();
          alert(`å‰Šé™¤å¤±æ•—: ${error.detail}`);
        }
      } catch (err) {
        alert("ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
        console.error(err);
      }
    }

    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã« ì„ íƒã•ã‚ŒãŸãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
    const layerSelect = document.getElementById('layerSelect');
    loadLayerData(layerSelect.value);

    // ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠæ™‚ã«ãƒ‡ãƒ¼ã‚¿ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
    layerSelect.addEventListener('change', () => {
      loadLayerData(layerSelect.value);
    });

    // ãƒãƒƒãƒ—ç§»å‹•ã¾ãŸã¯ã‚ºãƒ¼ãƒ æ™‚ã«ãƒ‡ãƒ¼ã‚¿ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
    map.on('moveend zoomend', () => {
      loadLayerData(layerSelect.value);
    });

    // å®šæœŸçš„ã«å¤‰æ›´æ¤œçŸ¥
    setInterval(checkReload, 5000);
  </script>
</body>
</html>