<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>病院検索</title>
  <link rel="stylesheet" href="/web/chat.css?v=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    #map {
      height: 400px;
      width: 400px;
      margin: 10px auto;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }
    .location-input {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 10px auto;
      max-width: 360px;
      align-items: center;
    }
    .input-row {
      display: flex;
      gap: 10px;
      width: 100%;
    }
    .input-row input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
    }
    .button-row {
      display: flex;
      gap: 10px;
      width: 100%;
      justify-content: center;
    }
    .button-row button {
      background-color: #0066ff;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      flex: 1;
      max-width: 120px;
    }
    .button-row button:hover {
      background-color: #0055dd;
    }
    .button-row button:active {
      transform: scale(0.95);
    }
    .hospital-list {
      max-width: 360px;
      margin: 10px auto;
    }
    .hospital-item {
      padding: 10px;
      border-bottom: 1px solid #ccc;
      font-size: 14px;
    }
    .hospital-item strong {
      color: #333;
    }
    #error {
      color: red;
      max-width: 360px;
      margin: 10px auto;
      display: none;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="top-bar">
      <span class="back-arrow" onclick="window.history.back()">←</span>
      <span class="bookmark">🔖</span>
    </div>
    <div class="location-input">
      <div class="input-row">
        <input type="number" id="lat" placeholder="緯度" step="any">
        <input type="number" id="lon" placeholder="経度" step="any">
      </div>
      <div class="button-row">
        <button id="search-btn">確認</button>
        <button id="current-location">現在地</button>
      </div>
    </div>
    <div id="map"></div>
    <div class="hospital-list">
      <div class="hospital-item">位置を入力して近くの病院を検索してください。</div>
    </div>
    <div id="error"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // 지도 초기화
    const MAP_CENTER = [35.65525241124183, 139.76066445459867]; // 기본 위치 (도쿄)
    const map = L.map('map').setView(MAP_CENTER, 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data © OpenStreetMap contributors'
    }).addTo(map);

    let markersLayer = L.layerGroup().addTo(map);

    function createMarker(m, layer) {
      if (m.lat == null || m.lon == null || isNaN(m.lat) || isNaN(m.lon) ||
          m.lat < -90 || m.lat > 90 || m.lon < -180 || m.lon > 180) {
        console.warn(`Invalid coordinates for marker ID ${m.id}: lat=${m.lat}, lon=${m.lon}`);
        return null;
      }
      const marker = L.marker([m.lat, m.lon], {
        icon: L.icon({
          iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png`,
          iconSize: [25, 41],
          iconAnchor: [12.5, 41],
          popupAnchor: [0, -51],
        })
      })
        .bindPopup(
          `<b>🏥 病院</b><br/>
           ID: ${m.id}<br/>
           名前: ${m.name || 'N/A'}<br/>
           URL: ${m.phone || 'N/A'}`
        )
        .on('add', () => {
          console.log(`Marker ID ${m.id} added to layer ${layer} at [${m.lat}, ${m.lon}]`);
        });
      return marker;
    }

    // 초기 위치 설정
    function initializeLocation() {
      const defaultLat = 35.65525241124183;
      const defaultLon = 139.76066445459867;
      document.getElementById("lat").value = defaultLat;
      document.getElementById("lon").value = defaultLon;
      fetchHospitals(defaultLat, defaultLon);
    }

    // 초기화 실행
    initializeLocation();

    // 검색 버튼 클릭 이벤트
    document.getElementById("search-btn").addEventListener("click", () => {
      const lat = parseFloat(document.getElementById("lat").value);
      const lon = parseFloat(document.getElementById("lon").value);
      if (lat && lon && !isNaN(lat) && !isNaN(lon)) {
        fetchHospitals(lat, lon);
      } else {
        document.getElementById("error").style.display = "block";
        document.getElementById("error").textContent = "有効な緯度と経度を入力してください。";
      }
    });

        // 현재 위치 버튼: 초기 위치로 되돌리기
    document.getElementById("current-location").addEventListener("click", () => {
      const defaultLat = 35.65525241124183;
      const defaultLon = 139.76066445459867;
      document.getElementById("lat").value = defaultLat;
      document.getElementById("lon").value = defaultLon;
      fetchHospitals(defaultLat, defaultLon);
    });
    
    // 병원 검색 함수
    function fetchHospitals(lat, lon) {
      document.getElementById("error").style.display = "none";
      fetch(`/hospital/nearby?lat=${lat}&lon=${lon}`)
        .then(res => {
          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
          return res.json();
        })
        .then(data => {
          console.log("API 응답:", data);
          // 기존 마커 제거
          map.eachLayer(layer => {
            if (layer instanceof L.Marker) map.removeLayer(layer);
          });

          // 사용자 위치 마커 추가
          const userMarker = L.marker([lat, lon], {
            icon: L.icon({
              iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
              iconSize: [25, 41],
              iconAnchor: [12.5, 41],
              popupAnchor: [0, -41]
            })
          }).addTo(map).bindPopup('<b>現在地</b>');
          if (!userMarker._icon) console.error("マーカーアイコンがロードされませんでした。");

          // 병원 마커 추가
          const hospitals = data.nearest_hospitals || [];
          const bounds = [[lat, lon]];
          hospitals.forEach(h => {
            if (h.lat && h.lon && !isNaN(h.lat) && !isNaN(h.lon)) {
              const marker = L.marker([h.lat, h.lon]).addTo(map)
                .bindPopup(`<b>${h.name || '名称なし'}</b><br>URL: ${h.phone || 'なし'}`);
              bounds.push([h.lat, h.lon]);
              if (!marker._icon) console.error("病院マーカーがロードされませんでした。");
            }
          });

          // 지도 범위 조정
          if (bounds.length > 1) {
            map.fitBounds(bounds, { padding: [50, 50] });
          } else {
            map.setView([lat, lon], 13);
          }

          // 병원 목록 업데이트
          const hospitalList = document.querySelector(".hospital-list");
          hospitalList.innerHTML = hospitals.length > 0
            ? hospitals.map(h => `
                <div class="hospital-item">
                  <strong>${h.name || '名称なし'}</strong><br>
                  位置: ${h.lat.toFixed(6)}, ${h.lon.toFixed(6)}<br>
                  電話: ${h.phone || 'なし'}
                </div>
              `).join("")
            : "<div class='hospital-item'>近くの病院が見つかりませんでした。</div>";
        })
        .catch(err => {
          console.error("病院検索エラー:", err);
          document.getElementById("error").style.display = "block";
          document.getElementById("error").textContent = "病院検索中にエラーが発生しました。";
        });
    }

  // 검색 버튼 이벤트
  document.getElementById("search-btn").addEventListener("click", () => {
    const lat = parseFloat(document.getElementById("lat").value);
    const lon = parseFloat(document.getElementById("lon").value);

    if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
      document.getElementById("error").textContent = "有効な緯度・経度を入力してください。";
      return;
    }

    fetchHospitals(lat, lon);
  });

  // 현재 위치 버튼 이벤트
  document.getElementById("current-location").addEventListener("click", () => {
	initializeLocation();
  });
  </script>
</body>
</html>
