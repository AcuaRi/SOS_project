<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë³‘ì› ì°¾ê¸°</title>
  <link rel="stylesheet" href="/web/chat.css?v=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    #map {
      height: 400px;
      width: 100%;
      max-width: 360px;
      margin: 10px auto;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    .location-input {
      display: flex;
      gap: 10px;
      margin: 10px auto;
      max-width: 360px;
      align-items: center;
    }
    .location-input input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
    }
    .location-input button {
      background-color: #0066ff;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
    }
    .location-input button:hover {
      background-color: #0055dd;
    }
    .location-input button:active {
      transform: scale(0.95);
    }
    .hospital-list {
      max-width: 360px;
      margin: 10px auto;
    }
    .hospital-item {
      padding: 10px;
      border-bottom: 1px solid #ccc;
      font-size: 14px;
    }
    .hospital-item strong {
      color: #333;
    }
    #error {
      color: red;
      max-width: 360px;
      margin: 10px auto;
      display: none;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="top-bar">
      <span class="back-arrow" onclick="window.history.back()">â†</span>
      <span class="bookmark">í ½í´–</span>
    </div>
    <div class="location-input">
      <input type="number" id="lat" placeholder="ìœ„ë„" step="any">
      <input type="number" id="lon" placeholder="ê²½ë„" step="any">
      <button id="search-btn">í™•ì¸</button>
      <button id="current-location">í˜„ì¬ ìœ„ì¹˜</button>
    </div>
    <div id="error"></div>
    <div id="map"></div>
    <div class="hospital-list">
      <div class="hospital-item">ìœ„ì¹˜ë¥¼ ì…ë ¥í•˜ì—¬ ê·¼ì²˜ ë³‘ì›ì„ ê²€ìƒ‰í•˜ì„¸ìš”.</div>
    </div>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // ì§€ë„ ì´ˆê¸°í™”
      const map = L.map('map').setView([35.6762, 139.6503], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Map data Â© OpenStreetMap contributors'
      }).addTo(map);

      // í™•ì¸ ë²„íŠ¼
      document.getElementById("search-btn").addEventListener("click", () => {
        const lat = parseFloat(document.getElementById("lat").value);
        const lon = parseFloat(document.getElementById("lon").value);
        if (lat && lon && !isNaN(lat) && !isNaN(lon)) {
          fetchHospitals(lat, lon);
        } else {
          document.getElementById("error").style.display = "block";
          document.getElementById("error").textContent = "ìœ íš¨í•œ ìœ„ë„ì™€ ê²½ë„ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
        }
      });

      // í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼
      document.getElementById("current-location").addEventListener("click", () => {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            document.getElementById("lat").value = lat;
            document.getElementById("lon").value = lon;
            fetchHospitals(lat, lon);
          },
          (err) => {
            console.error("ìœ„ì¹˜ ì¶”ì  ì‹¤íŒ¨:", err);
            document.getElementById("error").style.display = "block";
            document.getElementById("error").textContent = "ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
          }
        );
      });

      function fetchHospitals(lat, lon) {
        document.getElementById("error").style.display = "none";
        fetch(`/hospital/nearby?lat=${lat}&lon=${lon}`)
          .then(res => {
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            return res.json();
          })
          .then(data => {
            // ì§€ë„ ì¤‘ì‹¬ ì´ë™
            map.setView([lat, lon], 13);
            // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
            map.eachLayer(layer => {
              if (layer instanceof L.Marker) map.removeLayer(layer);
            });
            // ì‚¬ìš©ì ìœ„ì¹˜ ë§ˆì»¤ ì¶”ê°€ (ë¹¨ê°„ìƒ‰)
            L.marker([lat, lon], {
              icon: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                iconSize: [25, 41],
                iconAnchor: [12.5, 41],
                popupAnchor: [0, -41]
              })
            }).addTo(map).bindPopup('<b>í˜„ì¬ ìœ„ì¹˜</b>');

            // ë³‘ì› ë§ˆì»¤ ì¶”ê°€
            const hospitals = data.nearest_hospitals || [];
            hospitals.forEach(h => {
              if (h.lat && h.lon && !isNaN(h.lat) && !isNaN(h.lon)) {
                L.marker([h.lat, h.lon]).addTo(map)
                  .bindPopup(`<b>${h.name || 'ì´ë¦„ ì—†ìŒ'}</b><br>ì „í™”: ${h.phone || 'ì—†ìŒ'}`);
              }
            });

            // ë³‘ì› ëª©ë¡ ì—…ë°ì´íŠ¸
            const hospitalList = document.querySelector(".hospital-list");
            hospitalList.innerHTML = hospitals.length > 0
              ? hospitals.map(h => `
                  <div class="hospital-item">
                    <strong>${h.name || 'ì´ë¦„ ì—†ìŒ'}</strong><br>
                    ìœ„ì¹˜: ${h.lat.toFixed(6)}, ${h.lon.toFixed(6)}<br>
                    ì „í™”: ${h.phone || 'ì—†ìŒ'}
                  </div>
                `).join("")
              : "<div class='hospital-item'>ê·¼ì²˜ ë³‘ì›ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>";
          })
          .catch(err => {
            console.error("ë³‘ì› ê²€ìƒ‰ ì‹¤íŒ¨:", err);
            document.getElementById("error").style.display = "block";
            document.getElementById("error").textContent = "ë³‘ì› ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
          });
      }
    });
  </script>
</body>
</html>