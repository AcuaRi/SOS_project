<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç—…é™¢æ¤œç´¢</title>
  <link rel="stylesheet" href="/web/chat.css?v=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    #map {
      height: 400px;
      width: 400px;
      margin: 10px auto;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }
    .location-input {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 10px auto;
      max-width: 360px;
      align-items: center;
    }
    .input-row {
      display: flex;
      gap: 10px;
      width: 100%;
    }
    .input-row input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
    }
    .button-row {
      display: flex;
      gap: 10px;
      width: 100%;
      justify-content: center;
    }
    .button-row button {
      background-color: #0066ff;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      flex: 1;
      max-width: 120px;
    }
    .button-row button:hover {
      background-color: #0055dd;
    }
    .button-row button:active {
      transform: scale(0.95);
    }
    .hospital-list {
      max-width: 360px;
      margin: 10px auto;
    }
    .hospital-item {
      padding: 10px;
      border-bottom: 1px solid #ccc;
      font-size: 14px;
    }
    .hospital-item strong {
      color: #333;
    }
    #error {
      color: red;
      max-width: 360px;
      margin: 10px auto;
      display: none;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="top-bar">
      <span class="back-arrow" onclick="window.history.back()">â†</span>
      <span class="bookmark">ğŸ”–</span>
    </div>
    <div class="location-input">
      <div class="input-row">
        <input type="number" id="lat" placeholder="ç·¯åº¦" step="any">
        <input type="number" id="lon" placeholder="çµŒåº¦" step="any">
      </div>
      <div class="button-row">
        <button id="search-btn">ç¢ºèª</button>
        <button id="current-location">ç¾åœ¨åœ°</button>
      </div>
    </div>
    <div id="map"></div>
    <div class="hospital-list">
      <div class="hospital-item">ä½ç½®ã‚’å…¥åŠ›ã—ã¦è¿‘ãã®ç—…é™¢ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„ã€‚</div>
    </div>
    <div id="error"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ì§€ë„ ì´ˆê¸°í™”
    const MAP_CENTER = [35.65525241124183, 139.76066445459867]; // ê¸°ë³¸ ìœ„ì¹˜ (ë„ì¿„)
    const map = L.map('map').setView(MAP_CENTER, 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data Â© OpenStreetMap contributors'
    }).addTo(map);

    let markersLayer = L.layerGroup().addTo(map);

    function createMarker(m, layer) {
      if (m.lat == null || m.lon == null || isNaN(m.lat) || isNaN(m.lon) ||
          m.lat < -90 || m.lat > 90 || m.lon < -180 || m.lon > 180) {
        console.warn(`Invalid coordinates for marker ID ${m.id}: lat=${m.lat}, lon=${m.lon}`);
        return null;
      }
      const marker = L.marker([m.lat, m.lon], {
        icon: L.icon({
          iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png`,
          iconSize: [25, 41],
          iconAnchor: [12.5, 41],
          popupAnchor: [0, -51],
        })
      })
        .bindPopup(
          `<b>ğŸ¥ ç—…é™¢</b><br/>
           ID: ${m.id}<br/>
           åå‰: ${m.name || 'N/A'}<br/>
           URL: ${m.phone || 'N/A'}`
        )
        .on('add', () => {
          console.log(`Marker ID ${m.id} added to layer ${layer} at [${m.lat}, ${m.lon}]`);
        });
      return marker;
    }

    // ì´ˆê¸° ìœ„ì¹˜ ì„¤ì •
    function initializeLocation() {
      const defaultLat = 35.65525241124183;
      const defaultLon = 139.76066445459867;
      document.getElementById("lat").value = defaultLat;
      document.getElementById("lon").value = defaultLon;
      fetchHospitals(defaultLat, defaultLon);
    }

    // ì´ˆê¸°í™” ì‹¤í–‰
    initializeLocation();

    // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    document.getElementById("search-btn").addEventListener("click", () => {
      const lat = parseFloat(document.getElementById("lat").value);
      const lon = parseFloat(document.getElementById("lon").value);
      if (lat && lon && !isNaN(lat) && !isNaN(lon)) {
        fetchHospitals(lat, lon);
      } else {
        document.getElementById("error").style.display = "block";
        document.getElementById("error").textContent = "æœ‰åŠ¹ãªç·¯åº¦ã¨çµŒåº¦ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
      }
    });

        // í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼: ì´ˆê¸° ìœ„ì¹˜ë¡œ ë˜ëŒë¦¬ê¸°
    document.getElementById("current-location").addEventListener("click", () => {
      const defaultLat = 35.65525241124183;
      const defaultLon = 139.76066445459867;
      document.getElementById("lat").value = defaultLat;
      document.getElementById("lon").value = defaultLon;
      fetchHospitals(defaultLat, defaultLon);
    });
    
    // ë³‘ì› ê²€ìƒ‰ í•¨ìˆ˜
    function fetchHospitals(lat, lon) {
      document.getElementById("error").style.display = "none";
      fetch(`/hospital/nearby?lat=${lat}&lon=${lon}`)
        .then(res => {
          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
          return res.json();
        })
        .then(data => {
          console.log("API ì‘ë‹µ:", data);
          // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
          map.eachLayer(layer => {
            if (layer instanceof L.Marker) map.removeLayer(layer);
          });

          // ì‚¬ìš©ì ìœ„ì¹˜ ë§ˆì»¤ ì¶”ê°€
          const userMarker = L.marker([lat, lon], {
            icon: L.icon({
              iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
              iconSize: [25, 41],
              iconAnchor: [12.5, 41],
              popupAnchor: [0, -41]
            })
          }).addTo(map).bindPopup('<b>ç¾åœ¨åœ°</b>');
          if (!userMarker._icon) console.error("ãƒãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚");

          // ë³‘ì› ë§ˆì»¤ ì¶”ê°€
          const hospitals = data.nearest_hospitals || [];
          const bounds = [[lat, lon]];
          hospitals.forEach(h => {
            if (h.lat && h.lon && !isNaN(h.lat) && !isNaN(h.lon)) {
              const marker = L.marker([h.lat, h.lon]).addTo(map)
                .bindPopup(`<b>${h.name || 'åç§°ãªã—'}</b><br>URL: ${h.phone || 'ãªã—'}`);
              bounds.push([h.lat, h.lon]);
              if (!marker._icon) console.error("ç—…é™¢ãƒãƒ¼ã‚«ãƒ¼ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚");
            }
          });

          // ì§€ë„ ë²”ìœ„ ì¡°ì •
          if (bounds.length > 1) {
            map.fitBounds(bounds, { padding: [50, 50] });
          } else {
            map.setView([lat, lon], 13);
          }

          // ë³‘ì› ëª©ë¡ ì—…ë°ì´íŠ¸
          const hospitalList = document.querySelector(".hospital-list");
          hospitalList.innerHTML = hospitals.length > 0
            ? hospitals.map(h => `
                <div class="hospital-item">
                  <strong>${h.name || 'åç§°ãªã—'}</strong><br>
                  ä½ç½®: ${h.lat.toFixed(6)}, ${h.lon.toFixed(6)}<br>
                  é›»è©±: ${h.phone || 'ãªã—'}
                </div>
              `).join("")
            : "<div class='hospital-item'>è¿‘ãã®ç—…é™¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>";
        })
        .catch(err => {
          console.error("ç—…é™¢æ¤œç´¢ã‚¨ãƒ©ãƒ¼:", err);
          document.getElementById("error").style.display = "block";
          document.getElementById("error").textContent = "ç—…é™¢æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
        });
    }

  // ê²€ìƒ‰ ë²„íŠ¼ ì´ë²¤íŠ¸
  document.getElementById("search-btn").addEventListener("click", () => {
    const lat = parseFloat(document.getElementById("lat").value);
    const lon = parseFloat(document.getElementById("lon").value);

    if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
      document.getElementById("error").textContent = "æœ‰åŠ¹ãªç·¯åº¦ãƒ»çµŒåº¦ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
      return;
    }

    fetchHospitals(lat, lon);
  });

  // í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ ì´ë²¤íŠ¸
  document.getElementById("current-location").addEventListener("click", () => {
	initializeLocation();
  });
  </script>
</body>
</html>
